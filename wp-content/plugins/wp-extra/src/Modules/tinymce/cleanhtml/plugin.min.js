(function() {
    tinymce.PluginManager.add('cleanhtml', function(editor, url) {
        editor.addButton('cleanhtml', {
            title: 'Clean HTML',
            icon: 'insert-spellcheck is-dashicon dashicons dashicons-editor-spellcheck',
            onPostRender: function() {
                jQuery('.is-dashicon').css('font-family', 'dashicons');
            },
            onclick: function() {
                var content = editor.getContent();
                var whitelist = 'p,b,strong,i,em,h2,h3,h4,h5,h6,ul,li,ol,a,href,img,table,tr,td';
                var stripped = jQuery('<div>' + content + '</div>');
                var els = stripped.find('*').not(whitelist);
                
                for (var i = els.length - 1; i >= 0; i--) {
                    var e = els[i];
                    jQuery(e).replaceWith(e.innerHTML);
                }
                stripped.find('img').removeAttr('data-srcset');
                stripped.find('img').removeAttr('data-sizes');
                stripped.find('img').removeAttr('data-orig-sizes');
                stripped.find('img').removeAttr('data-orig-src');
                stripped.find('*').removeAttr('id class style data-* aria-*');
                
                var cleanedContent = stripped.html();
                editor.setContent(cleanedContent);
            }
        });
    });
})();
